===============================================================================
                    AgencyManager Pro - Project Story
                    Last Updated: 2026-02-19
===============================================================================

OVERVIEW
--------
AgencyManager Pro is a CRM/Dashboard system for managing a digital marketing
agency. Built for a user who runs an agency as a self-employed business while
also being salaried. The app tracks clients, leads, deals, expenses, debts,
and provides financial dashboards.

Tech: React 19 + Vite + TypeScript + Supabase + React Router (HashRouter)
UI: Tailwind CSS via CDN, Heebo font, dark theme, RTL Hebrew layout
Hosting: GitHub -> Vercel (auto-deploy)

===============================================================================
SESSION 1 (2026-02-14) - Audit & Bug Fixes
===============================================================================

WHAT HAPPENED:
User asked to investigate the codebase for broken/problematic things.
Full audit was performed, identifying 19 issues across 4 severity levels.

ISSUES FOUND & FIXED:
1. [CRITICAL] `any` types everywhere -> Created proper DB row interfaces
   (ClientRow, LeadRow, DealRow, ExpenseRow, PaymentRow, SettingsRow)
2. [CRITICAL] JSON.parse without try-catch -> Created `safeJsonParse` helper
3. [CRITICAL] Non-atomic convertLeadToClient -> Added rollback on failure
4. [HIGH] Debug console.logs in supabaseClient.ts -> Removed
5. [HIGH] STORAGE_KEY dead code in constants.ts -> Removed
6. [HIGH] No error feedback to user -> Added error/clearError to DataContext,
   error toast in Dashboard
7. [HIGH] `isLoaded` not exposed from context -> Added to DataContextType
8. [MEDIUM] Native confirm() dialogs -> Styled Modal confirmations in
   Clients.tsx, Leads.tsx, Debts.tsx
9. [MEDIUM] Missing custom-scrollbar CSS class -> Added to index.html <style>
10. [MEDIUM] RTL margin issues (ml/mr) -> Fixed to logical ms/me in Button.tsx
11. [MEDIUM] Modal z-index conflict with sidebar -> z-50 -> z-[60]
12. [MEDIUM] Accessibility: Added role, aria-modal, aria-label to Modal.tsx
13. [MEDIUM] Accessibility: Added aria-labels to Layout.tsx sidebar buttons
14. [MEDIUM] Login.tsx responsive issues -> Fixed width/padding
15. [MEDIUM] Login.tsx mixed Hebrew/English text -> Unified
16. [MEDIUM] Settings.tsx RTL toggle animation -> Fixed translate direction
17. [MEDIUM] Settings.tsx missing FileReader.onerror -> Added
18. [MEDIUM] Settings.tsx typo "דרוס" -> "דורס"
19. [LOW] Typed all component props (KPICardProps, SidebarItemProps)

FILES MODIFIED:
- lib/supabaseClient.ts (removed debug logs)
- constants.ts (removed STORAGE_KEY)
- contexts/DataContext.tsx (major rewrite: types, error handling, async)
- components/ui/Modal.tsx (z-index, accessibility)
- components/ui/Button.tsx (RTL fix)
- components/Login.tsx (responsive, accessibility, text)
- components/Settings.tsx (RTL toggle, error handling, typo)
- components/Layout.tsx (typed props, aria-labels)
- components/Dashboard.tsx (typed props, error toast, LucideIcon)
- components/Clients.tsx (confirm delete modal)
- components/Leads.tsx (confirm convert modal)
- components/Debts.tsx (confirm delete modal, aria-labels)
- index.html (custom-scrollbar CSS)

DELETED:
- agencymanager-pro/agencymanager-pro/ (duplicate nested directory)

Build verified: `npm run build` succeeded.
Committed: 443c937 - "Fix 19 audit issues..."
Pushed to GitHub -> Vercel auto-deployed.

===============================================================================
SESSION 2 (2026-02-14) - 9 Feature Upgrades ✅ COMPLETED
===============================================================================

USER REQUESTED 9 NEW FEATURES (everything except PDF reports):

FEATURE 1: Israel Tax Calculator
- User is salaried (20K/month) + self-employed (agency income)
- Calculate net income after Israeli tax brackets + Bituach Leumi
- Display: KPI card in Dashboard + collapsible breakdown + dedicated page
- Tax brackets 2025-2026 (frozen): 10%/14%/20%/31%/35%/47%/50%
- Credit points: 2.25 x 242 = 544.50 NIS/month
- BL self-employed: 9.07% (up to 7,522) / 22.83% (7,523-49,030)
- Store employeeSalary in AgencySettings
- New files: utils/taxCalculator.ts, components/TaxCalculator.tsx

FEATURE 2: Multi-User Role System
- Admin (owner) sees everything
- Viewer (freelancers) sees: their own leads + mini dashboard
- Supabase table: user_roles (user_id, role, display_name)
- Add created_by to leads table
- New file: contexts/AuthContext.tsx
- Conditional sidebar, route gating, user management in Settings

FEATURE 3: Fix YoY Growth
- Dashboard.tsx line 73 has hardcoded `mrrChangePercent = 10`
- Replace with actual calculation using calculateMRRForMonth()

FEATURE 4: Notification Badges
- Red dot/counter on sidebar items
- "לידים" shows overdue leads count
- "חובות לקוחות" shows unpaid debts count

FEATURE 5: Edit/Delete Expenses
- Currently only addExpense exists
- Add updateExpense/deleteExpense to DataContext
- Add edit/delete UI in Expenses.tsx (follow Debts.tsx pattern)

FEATURE 6: Auto-Generate Monthly Debts
- Button to auto-create payment records for all active clients
- Based on monthlyRetainer, prevents duplicates

FEATURE 7: Client Profile Page
- /clients/:clientId route
- Shows contact info, financials, deals, expenses, payments history

FEATURE 8: Global Search (Ctrl+K)
- Command palette searching across clients, leads, deals
- Keyboard navigation, grouped results

FEATURE 9: Activity Log
- Track CRUD operations in Supabase activity_log table
- Show recent activity in Dashboard

COMPLETED FEATURES LOG:
- Feature 3 ✅: Fixed YoY Growth - replaced hardcoded 10% with actual calculation
- Feature 5 ✅: Edit/Delete Expenses - full CRUD in Expenses.tsx + DataContext
- Feature 1 ✅: Israel Tax Calculator - utils/taxCalculator.ts + TaxCalculator.tsx
  + Dashboard KPI + collapsible panel + Settings employee salary input
- Feature 6 ✅: Auto-Generate Monthly Debts - generateMonthlyPayments in DataContext
- Feature 4 ✅: Notification Badges - overdue leads + unpaid debts in sidebar
- Feature 7 ✅: Client Profile Page - /clients/:clientId with full history
- Feature 8 ✅: Global Search (Ctrl+K) - CommandPalette.tsx searching all entities
- Feature 9 ✅: Activity Log - logActivity in DataContext + ActivityLog.tsx in Dashboard
- Feature 2 ✅: Multi-User Role System - AuthContext.tsx, role-gated sidebar,
  viewer mini dashboard, filtered leads, user management in Settings

===============================================================================
SESSION 3 (2026-02-14) - Theme Toggle, Viewer Fix, Client File Uploads
===============================================================================

WHAT HAPPENED:
- Added dark/light theme toggle to Dashboard
- Fixed viewer role not being applied correctly
- Added client file uploads (contracts/documents) to ClientProfile
- Storage bucket "contracts" for Supabase Storage with RLS

===============================================================================
SESSION 4 (2026-02-14) - Retainer History, Advanced Roles, RLS, User Sync
===============================================================================

WHAT HAPPENED:
- Retainer change history tracking (retainer_changes table)
- Advanced page-level permissions for viewer roles (page_permissions JSON)
- Full RLS policies for all tables in supabase-migrations.sql
- User sync fix: match by email for pre-created viewers, then update user_id
- UUID casting fix in RLS policies (user_id is uuid type, not text)

===============================================================================
SESSION 5 (2026-02-14) - Edge Function, Lead Visibility, Enhanced CRM
===============================================================================

WHAT HAPPENED:
User wanted admin to create user accounts directly from CRM instead of
self-registration. Also reported viewer seeing empty system and no leads.
Then requested major CRM enhancements for client management.

CHANGES:

1. EDGE FUNCTION FOR USER CREATION
   - User explicitly rejected self-registration approach
   - Created `supabase/functions/create-user/index.ts` (Deno Edge Function)
   - Verifies caller is authenticated admin via user_roles table
   - Uses service_role key to call supabase.auth.admin.createUser()
   - Auto-confirms email, creates user_roles entry
   - AuthContext.tsx addViewer() now calls Edge Function
   - Settings.tsx: 3-column form (name, email, password) for adding users
   - Login.tsx: removed self-registration, only login + forgot password
   - Deployed via: npx supabase functions deploy create-user --project-ref rxckkozbkrabpjdgyxqm
   - Committed: 6925a1a

2. LEAD VISIBILITY FIX
   - Problem: Viewer (Natalie) saw empty system, no leads despite having permission
   - Root cause (dual layer):
     a) RLS policy restricted to admin OR created_by = auth.uid()
     b) Frontend filter: leads.filter(l => l.createdBy === user.id)
   - Fix: Changed both to allow all authenticated users to see all leads
   - RLS: leads_select USING (true)
   - Frontend: const visibleLeads = leads (no filtering)
   - Committed: 1085824

3. ENHANCED CLIENT MANAGEMENT (CRM Upgrade)
   User requested: assigned handler, notes history, click-to-view, UX improvements.

   a) Assigned Handler (מטפל)
      - Added `assignedTo?: string` to Client interface (types.ts)
      - Added `assigned_to uuid` column to clients table
      - Dropdown in edit modal with all users from allUsers
      - Shown in table as avatar + name column
      - Shown in ClientProfile header as violet badge

   b) Client Notes History
      - New `ClientNote` interface in types.ts
      - New `client_notes` Supabase table with RLS
      - CRUD functions in DataContext: addClientNote, deleteClientNote
      - ClientProfile: textarea + send button, notes list with avatars/timestamps
      - Admin-only delete with confirmation modal

   c) Click-to-View Client Profile
      - Entire table row is clickable -> navigates to /clients/:clientId
      - Action buttons (edit/delete) stop propagation
      - Row has cursor-pointer + hover effect

   d) UX Improvements
      - Quick stats bar above client table (active count, revenue, profit, total)
      - Effort level colored dots (green/yellow/red)
      - Inline status/rating dropdowns on client profile
      - Activity timeline on profile (filtered from activity_log)
      - getRelativeTime helper for timestamp display

   FILES MODIFIED:
   - types.ts (assignedTo, ClientNote, clientNotes in AppData)
   - contexts/DataContext.tsx (ClientNoteRow, transforms, CRUD, loadData)
   - components/Clients.tsx (row click, handler column, stats bar, effort dots)
   - components/ClientProfile.tsx (notes, inline edit, activity, handler badge)
   - supabase-migrations.sql (assigned_to column, client_notes table + RLS)

   SQL MIGRATION (user needs to run):
     ALTER TABLE clients ADD COLUMN assigned_to uuid DEFAULT NULL;
     CREATE TABLE client_notes (...);
     + RLS policies for client_notes

   Committed: 0c3cea1
   Pushed to GitHub -> Vercel auto-deployed.

===============================================================================
SESSION 6 (2026-02-15) - Lead Management Upgrade + AI + Proposals
===============================================================================

WHAT HAPPENED:
Major CRM expansion: full lead profile page, call transcripts system,
AI-powered recommendations, and Canva proposal generation. Security
hardening moved API keys to server-side only.

CHANGES:

1. LEAD PROFILE PAGE (LeadProfile.tsx)
   - Full CRM view for leads (similar to ClientProfile)
   - Route: /leads/:leadId
   - Contact info, financial summary, notes history, transcripts,
     AI recommendations, WhatsApp messages, proposals
   - Lead assigned handler (assignedTo uuid)
   - Lead notes history (lead_notes table)

2. CALL TRANSCRIPTS SYSTEM
   - New `call_transcripts` table (client_id, lead_id, call_date,
     participants, transcript, summary, full_text, recording_url)
   - Manual transcript entry from profile pages
   - Audio upload -> Gemini transcription (see Session 7)

3. AI RECOMMENDATIONS
   - New Edge Function: ai-recommendations/index.ts
   - Generates actionable advice based on notes + transcripts via Gemini API
   - New `ai_recommendations` table (client_id, lead_id, recommendation)
   - Expandable recommendation cards in profile
   - Persistent storage with admin-only delete

4. CANVA PROPOSAL GENERATION
   - New Edge Function: generate-proposal/index.ts
   - Uses Canva Connect API to autofill brand template with lead data
   - Autofills: business name, client name, price, services, contact, date
   - Exports to PDF (polling for completion)
   - Returns: Canva design URL + PDF download URL

5. API KEYS SERVER-SIDE ONLY
   - Gemini API key + Canva API key stored in settings table
   - Frontend only sees boolean flags (hasGeminiKey, hasCanvaKey)
   - Edge Functions access keys via service_role client

FILES MODIFIED:
- types.ts (LeadNote, CallTranscript, AIRecommendation interfaces)
- contexts/DataContext.tsx (new CRUD: call transcripts, AI recommendations, lead notes)
- components/LeadProfile.tsx (NEW: full lead CRM profile)
- components/Leads.tsx (click-to-view, handler column)
- supabase/functions/ai-recommendations/index.ts (NEW)
- supabase/functions/generate-proposal/index.ts (NEW)
- components/Settings.tsx (API key management UI)

Commits: 89a3947, fd2946a, 67f4fa4, 6d6edbb
Pushed to GitHub -> Vercel auto-deployed.

===============================================================================
SESSION 7 (2026-02-15) - WhatsApp Messages + Audio Transcription
===============================================================================

WHAT HAPPENED:
Added AI-powered WhatsApp message generation and audio transcription
for call recordings.

CHANGES:

1. WHATSAPP OUTGOING MESSAGES
   - New Edge Function: generate-whatsapp-messages/index.ts
   - Generates 3 message variants via Gemini API:
     Variant 1: formal-professional
     Variant 2: friendly-warm
     Variant 3: direct-purposeful
   - MESSAGE_PURPOSES constant (follow_up, meeting_reminder, proposal_sent,
     thank_you, check_in, intro, renewal, service_update, performance_report, custom)
   - New `whatsapp_messages` table for message log
   - wa.me deep link integration (formatPhoneForWhatsApp utility)
   - UI: purpose dropdown, generate button, 3-variant cards with
     "Edit" and "Send to WhatsApp" buttons, custom message textarea,
     message history with expand/collapse

2. AUDIO TRANSCRIPTION
   - New Edge Function: transcribe-audio/index.ts
   - Uploads audio to Supabase Storage (recordings bucket)
   - Sends to Gemini API for Hebrew transcription
   - Splits output into transcript + summary
   - Hebrew-optimized prompt with speaker detection

FILES MODIFIED:
- types.ts (WhatsAppMessage interface)
- constants.ts (MESSAGE_PURPOSES)
- contexts/DataContext.tsx (WhatsApp CRUD, recording upload)
- components/ClientProfile.tsx (WhatsApp section, audio upload)
- components/LeadProfile.tsx (WhatsApp section, audio upload)
- supabase/functions/generate-whatsapp-messages/index.ts (NEW)
- supabase/functions/transcribe-audio/index.ts (NEW)

Committed: e1e83c7
Pushed to GitHub -> Vercel auto-deployed.

===============================================================================
SESSION 8 (2026-02-15) - Transcription Bug Fixes + Gemini Files API
===============================================================================

WHAT HAPPENED:
Series of fixes for audio transcription reliability. Culminated in
migrating to Gemini Files API to avoid Edge Function memory limits.

ISSUES & FIXES:
1. Improved transcription error messages with specific failure details
2. Fixed audio upload MIME type handling for M4A/MP4 files
3. Removed Hebrew characters from storage file paths (400 Bad Request)
4. Improved transcription prompt with explicit ---SUMMARY_START--- separator
5. Upgraded transcription model to gemini-2.5-flash for Hebrew quality
6. Migrated to Gemini Files API (resumable upload) to avoid Edge Function
   memory limit (error 546). Audio files now uploaded to Gemini's file
   storage first, then referenced by file_uri in the generate request.

FILES MODIFIED:
- supabase/functions/transcribe-audio/index.ts (major rewrite: Gemini Files API)
- components/ClientProfile.tsx (recording upload fixes)
- components/LeadProfile.tsx (recording upload fixes)

Commits: 5643ebc, c45cf30, d22e7bf, 83231d7, ef5a45c, de6cefd, f143444
Pushed to GitHub -> Vercel auto-deployed.

===============================================================================
SESSION 9 (2026-02-15) - AI Summaries, Inline Editing, WhatsApp Fix, Gemini Upgrade
===============================================================================

WHAT HAPPENED:
Four major items: AI Summary Notes system, inline profile editing,
WhatsApp message parsing fix, and Gemini model upgrade.

CHANGES:

1. AI SUMMARY NOTES
   - New Edge Function: generate-ai-summary/index.ts
   - Three summary types (NoteType union in types.ts):
     a) transcript_summary - structured CRM summary of call transcript
     b) recommendation_summary - distilled action items from AI recommendations
     c) proposal_focus - guidance for preparing price proposals
        (services to offer, pain points, value prop, risks, tone)
   - Summaries saved as notes with noteType + sourceId
   - UI: buttons per type in AI Summaries section, expandable cards,
     duplicate prevention (disabled if summary exists for source)
   - note_type is TEXT column, no SQL migration needed

2. INLINE PROFILE EDITING
   - Added edit modal to ClientProfile (admin-only)
   - Added edit modal to LeadProfile (admin-only)
   - Edit button in profile header opens full form modal
   - All fields editable: personal, business, services, handler, notes

3. GEMINI MODEL UPGRADE
   - Audited all 4 Gemini Edge Functions for model versions
   - Strategy chosen: gemini-3-pro-preview for quality, gemini-2.5-flash for speed
   - ai-recommendations: 2.0-flash -> 3-pro-preview + ADDED thinking-parts filter
     (was missing entirely — only read parts?.[0]?.text)
   - generate-ai-summary: 2.5-flash -> 3-pro-preview (filter already existed)
   - generate-whatsapp-messages: kept on 2.5-flash initially (speed matters)
   - transcribe-audio: stays on 2.5-flash (large token counts)

4. WHATSAPP MESSAGE FIX (4 debugging iterations)
   - Problem: "Gemini לא הצליח ליצור הודעות" error with 500 status
   - Root cause: gemini-2.5-flash thinking mode wraps ALL content in thinking
     parts for simple JSON tasks, leaving rawText empty after !part.thought filter

   Iteration 1: Added responseMimeType: 'application/json' + thinkingConfig
   -> FAILED: "Invalid JSON payload. Unknown name thinkingConfig: Cannot find field"
   Learning: responseMimeType/thinkingConfig/responseSchema NOT supported in
   gemini-2.5-flash REST API (generativelanguage.googleapis.com/v1beta)

   Iteration 2: Removed unsupported fields, kept simple config
   -> FAILED: Still empty rawText after thinking-parts filter

   Iteration 3: Changed all error responses to status 200 (so frontend can read
   JSON body), added debug field to error responses
   -> Partially helped: confirmed rawText was indeed empty (parts=X, rawLen=0)

   Iteration 4 (FINAL FIX): Switched model to gemini-2.0-flash-lite
   -> SUCCESS: No thinking parts, simple reliable JSON output
   - Also added multi-level JSON parsing fallback:
     1) Direct JSON.parse
     2) Regex extract JSON array from response
     3) Split by numbered lines as last resort

FILES MODIFIED:
- types.ts (NoteType extended with proposal_focus)
- components/ClientProfile.tsx (edit modal, AI summary buttons, proposal focus, WhatsApp debug)
- components/LeadProfile.tsx (edit modal, AI summary buttons, proposal focus)
- supabase/functions/generate-ai-summary/index.ts (NEW: 3 summary types)
- supabase/functions/ai-recommendations/index.ts (model upgrade + thinking filter)
- supabase/functions/generate-whatsapp-messages/index.ts (4 iterations: model -> 2.0-flash-lite + parsing)

Commits: 83c5840, c3080f8, c14c9b3, 9b73c62, 5c4b723
All Edge Functions redeployed.

===============================================================================
SESSION 10 (2026-02-16) - Signals OS Integration
===============================================================================

WHAT HAPPENED:
Integrated Signals OS personality intelligence system into AgencyManager Pro.
Signals OS is a separate project that analyzes behavioral/personality archetypes
using AI questionnaires, deployed at signals-os-deploy.

CHANGES:

1. WEBHOOK INTEGRATION
   - Signals OS sends webhook to Supabase Edge Function on questionnaire completion
   - Edge Function: receives personality data, matches lead by email, updates lead record
   - New columns on leads table: archetype, archetype_description
   - Embeddable link generation for leads (pre-filled email in questionnaire URL)

2. PERSONALITY DISPLAY
   - LeadProfile.tsx: full personality card with archetype name + description
   - Leads.tsx Kanban cards: personality badge (Brain icon + archetype name)
   - AI recommendations incorporate personality data for better advice

3. SIGNALS OS DEPLOY PROJECT
   - Deployed to Vercel from signals-os-deploy directory
   - Webhook URL configured in Signals OS settings
   - Supabase Edge Function deployed for webhook processing

FILES MODIFIED:
- types.ts (archetype, archetypeDescription on Lead)
- contexts/DataContext.tsx (archetype fields in transforms)
- components/LeadProfile.tsx (personality display card)
- components/Leads.tsx (archetype badge in Kanban cards)

Committed: f6b39ba
Pushed to GitHub -> Vercel auto-deployed.

===============================================================================
SESSION 11 (2026-02-17) - Kanban Upgrade + Calendar + AI Receipt Scanning
===============================================================================

WHAT HAPPENED:
Three major feature additions: (1) Kanban board with drag & drop,
(2) Full calendar with events, (3) AI-powered receipt scanning.

CHANGES:

1. KANBAN DRAG & DROP UPGRADE
   - Installed @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities
   - Full-width layout for /leads and /calendar routes (removed max-w-7xl)
   - Rewrote KanbanView with DndContext, useDroppable columns, useSortable cards
   - DragOverlay ghost card during drag, closestCorners collision detection
   - Enriched cards: name, WhatsApp, business, phone, value, source, handler,
     next contact date (overdue highlight), Signals OS personality badge
   - Grid layout: responsive grid-cols-1/2/3/5

2. CALENDAR SYSTEM
   - New table: calendar_events (id, title, event_type, start_time, end_time,
     all_day, description, client_id, lead_id, created_by, created_by_name)
   - react-big-calendar + date-fns Hebrew locale (dateFnsLocalizer)
   - 5 event types: call (cyan), meeting (violet), zoom (blue), task (emerald), reminder (amber)
   - Month/Week/Day views with type legend
   - Virtual events from leads.nextContactDate (dashed border style)
   - Create/edit/delete modals with client/lead linking
   - RTL + dark/light theme CSS overrides for react-big-calendar
   - Page permission: 'calendar' added to role system

3. AI RECEIPT SCANNING
   - New Edge Function: process-receipt/index.ts
   - Gemini 2.0 Flash Vision API extracts: supplier, amount, date, category, description
   - Hebrew prompt for Israeli receipt/invoice parsing
   - receipt_url column added to expenses table
   - Storage bucket 'receipts' (10MB, images + PDF)
   - Two-phase modal UI: upload (drag & drop + preview) → review (editable fields
     + confidence indicator) → save as expense
   - Confidence color coding: green (>0.8), yellow (>0.5), red (<0.5)

SQL MIGRATIONS TO RUN:
  1. supabase-calendar-migration.sql — calendar_events table + indexes + RLS + realtime
  2. supabase-receipts-migration.sql — expenses.receipt_url + storage bucket + policies

EDGE FUNCTION TO DEPLOY:
  npx supabase functions deploy process-receipt --project-ref rxckkozbkrabpjdgyxqm

NEW DEPENDENCIES:
  @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities
  react-big-calendar, date-fns, @types/react-big-calendar

FILES MODIFIED:
- package.json (new dependencies)
- types.ts (CalendarEvent, CalendarEventType, receiptUrl, calendarEvents in AppData)
- contexts/DataContext.tsx (calendar CRUD, receipt upload/URL, calendar row transforms)
- contexts/AuthContext.tsx ('calendar' page permission)
- components/Layout.tsx (calendar sidebar item, full-width routes, CalendarDays icon)
- components/Leads.tsx (full Kanban rewrite with @dnd-kit, enriched cards)
- components/Expenses.tsx (receipt scanning modal, processing flow)
- App.tsx (calendar route)
- index.html (react-big-calendar CSS CDN + RTL/dark/light overrides)

NEW FILES:
- components/Calendar.tsx (full calendar page component)
- supabase/functions/process-receipt/index.ts (Gemini Vision receipt OCR)
- supabase-calendar-migration.sql
- supabase-receipts-migration.sql

TypeScript check passed (no new errors in modified files).
Pending: commit + push + SQL migrations + Edge Function deploy.

===============================================================================
SESSION 12 (2026-02-17) - Multi-Tenant + Freelancer + Voice + Ideas + Knowledge
===============================================================================

WHAT HAPPENED:
Five major features built together from the roadmap (items 4, 7, 8, 9, 10):
1. Multi-Tenant architecture
2. Freelancer role system
3. In-browser voice recording
4. Ideas Kanban board
5. Knowledge Base

CHANGES:

1. MULTI-TENANT FOUNDATION
   - New table: tenants (id, name, slug)
   - tenant_id uuid column added to ALL 15 tables with FK to tenants
   - Default tenant: '00000000-0000-0000-0000-000000000001'
   - Helper functions: current_tenant_id(), is_admin()
   - ALL RLS policies updated with tenant_id = current_tenant_id() filter
   - signals_personality uses tenant_id_fk (separate from existing text tenant_id)
   - AuthContext: +tenantId, +tenantName state, loaded from user_roles

2. FREELANCER ROLE
   - New UserRole: 'freelancer' (admin | viewer | freelancer)
   - is_freelancer() SQL helper function
   - RLS: freelancers see only clients/leads where assigned_to = auth.uid()
   - deals/notes scoped to freelancer's assigned clients via subquery
   - DEFAULT_FREELANCER_PERMISSIONS: dashboard, clients, leads, deals, calendar
   - Dashboard: mini dashboard for freelancers (assigned clients + leads)
   - Layout: freelancer badge (amber wrench icon, "פרילנסר" label)
   - Settings: role selector when adding users (פרילנסר/צופה)
   - create-user Edge Function: accepts role + tenantId params

3. IN-BROWSER VOICE RECORDING
   - New hook: hooks/useVoiceRecorder.ts
     - navigator.mediaDevices.getUserMedia + MediaRecorder API
     - AudioContext + AnalyserNode for audio level visualization
     - Codec fallback: webm/opus → webm → mp4
     - States: isRecording, isPaused, recordingTime, audioLevel
   - New component: VoiceRecorderButton.tsx
     - Three states: idle (mic), recording (red dot + timer + waveform), processing (spinner)
     - Auto-upload → transcribe → save transcript + AI summary note
   - Integrated in ClientProfile.tsx and LeadProfile.tsx next to "העלה הקלטה"

4. IDEAS KANBAN BOARD
   - New table: ideas (id, title, description, status, priority, client_id,
     lead_id, category, tags, assigned_to, due_date, sort_order, tenant_id)
   - 5 columns: draft, active, in_progress, done, archived
   - @dnd-kit drag & drop between columns
   - Client filter, search, priority badges, due dates
   - AI Generate: Edge Function generate-idea with Gemini 2.0 Flash-Lite
   - New component: Ideas.tsx (full kanban with add/edit/delete modals)

5. KNOWLEDGE BASE
   - New table: knowledge_articles (id, title, content, summary, category,
     tags, file_url, file_name, file_type, is_ai_generated, tenant_id)
   - Full-text search index (to_tsvector)
   - Storage bucket 'knowledge' (20MB, PDF/docs/images)
   - 7 categories: strategy, marketing, design, dev, operations, finance, general
   - AI Summarize: Edge Function summarize-document with Gemini 2.0 Flash-Lite
   - New component: KnowledgeBase.tsx (search, category tabs, card grid, file upload)

SQL MIGRATIONS TO RUN (IN ORDER):
  1. supabase-multi-tenant-migration.sql  (MUST be first — creates tenants table)
  2. supabase-freelancer-migration.sql    (depends on tenants)
  3. supabase-ideas-migration.sql
  4. supabase-knowledge-migration.sql

EDGE FUNCTIONS TO DEPLOY:
  npx supabase functions deploy create-user --project-ref rxckkozbkrabpjdgyxqm
  npx supabase functions deploy generate-idea --project-ref rxckkozbkrabpjdgyxqm
  npx supabase functions deploy summarize-document --project-ref rxckkozbkrabpjdgyxqm

NEW FILES (10):
- supabase-multi-tenant-migration.sql
- supabase-freelancer-migration.sql
- supabase-ideas-migration.sql
- supabase-knowledge-migration.sql
- hooks/useVoiceRecorder.ts
- components/VoiceRecorderButton.tsx
- components/Ideas.tsx
- components/KnowledgeBase.tsx
- supabase/functions/generate-idea/index.ts
- supabase/functions/summarize-document/index.ts

FILES MODIFIED (9):
- types.ts (Tenant, Idea, KnowledgeArticle, AppData)
- contexts/AuthContext.tsx (freelancer, tenant, ideas/knowledge permissions)
- contexts/DataContext.tsx (ideas + knowledge CRUD, transforms, uploadKnowledgeFile)
- components/Layout.tsx (sidebar: ideas/knowledge, freelancer badge, full-width)
- components/Dashboard.tsx (freelancer mini dashboard with assigned clients)
- components/Settings.tsx (role selector: freelancer/viewer)
- components/ClientProfile.tsx (+VoiceRecorderButton)
- components/LeadProfile.tsx (+VoiceRecorderButton)
- App.tsx (+routes: /ideas, /knowledge)
- supabase/functions/create-user/index.ts (+role, +tenantId)

TypeScript build verified: `npx vite build` succeeded.
Pending: commit + push + SQL migrations + Edge Function deploys.

===============================================================================
ARCHITECTURE NOTES (Updated 2026-02-17)
===============================================================================

Data Flow:
  Supabase (PostgreSQL) <-> DataContext.tsx <-> Components
  DB uses snake_case, TypeScript uses camelCase
  Transform functions handle conversion both ways

Component Structure:
  App.tsx (router + auth)
    -> Layout.tsx (sidebar + main area)
      -> [Page Components] (Dashboard, Clients, Leads, etc.)
        -> ClientProfile.tsx / LeadProfile.tsx (full CRM views)
        -> ui/ (Button, Card, Form, Modal, Badge, Table)

State Management:
  Single React Context (DataContext) holds all app state (~1100 lines)
  All CRUD operations are async with try/catch + error toast
  No external state libraries (Redux, Zustand, etc.)

Auth:
  Supabase Auth (email/password)
  Session check on App mount
  Role system: AuthContext.tsx with admin/viewer/freelancer roles
  Multi-tenant: tenant_id on all tables, current_tenant_id() SQL function
  Page-level permissions (page_permissions JSON in user_roles)
  Freelancer: sees only assigned clients/leads (assigned_to = auth.uid())
  First user auto-becomes admin
  Admin creates accounts via Edge Function (no self-registration)

AI / Gemini:
  gemini-3-pro-preview -> ai-recommendations, generate-ai-summary (quality)
  gemini-2.5-flash -> transcribe-audio (speed, large token counts)
  gemini-2.0-flash-lite -> generate-whatsapp-messages (no thinking parts, reliable JSON)
  gemini-2.0-flash -> process-receipt (Vision API, receipt OCR, temperature 0.1)
  API key stored server-side only (settings.gemini_api_key)
  Thinking parts filter: if (part.text && !part.thought) — needed for 2.5+ and 3.x
  gemini-2.0-flash-lite has NO thinking parts (simpler, ideal for JSON generation)
  WARNING: responseMimeType/thinkingConfig/responseSchema NOT supported in 2.5-flash REST API
  Audio uses Gemini Files API (resumable upload -> file_uri)

Edge Functions (9 total):
  create-user -> Admin account creation (+ role + tenantId)
  ai-recommendations -> AI advice via Gemini 3 Pro
  generate-ai-summary -> 3 summary types via Gemini 3 Pro
  generate-whatsapp-messages -> 3 message variants via Gemini 2.0 Flash-Lite
  transcribe-audio -> Audio -> text via Gemini Files API (2.5 Flash)
  generate-proposal -> PDF via Canva Connect API
  process-receipt -> Receipt OCR via Gemini 2.0 Flash Vision
  generate-idea -> AI idea generation via Gemini 2.0 Flash-Lite
  summarize-document -> AI document summarization via Gemini 2.0 Flash-Lite

Supabase Tables (all have tenant_id uuid FK):
  tenants (id, name, slug)
  clients (+ assigned_to uuid)
  leads (+ created_by, assigned_to uuid)
  deals, expenses (+ is_recurring, receipt_url), payments
  settings (+ employee_salary, gemini_api_key, canva_api_key, canva_template_id)
  activity_log, retainer_changes
  client_notes (+ note_type, source_id)
  lead_notes (+ note_type, source_id)
  call_transcripts (client_id, lead_id, transcript, summary, recording_url)
  ai_recommendations (client_id, lead_id, recommendation)
  whatsapp_messages (client_id, lead_id, message_text, purpose, is_ai_generated)
  calendar_events (id, title, event_type, start_time, end_time, all_day, description, client_id, lead_id)
  ideas (id, title, description, status, priority, client_id, category, tags, assigned_to, due_date, sort_order)
  knowledge_articles (id, title, content, summary, category, tags, file_url, is_ai_generated)
  user_roles (user_id, email, role, display_name, page_permissions, tenant_id)
  signals_personality (+ tenant_id_fk uuid FK)
  storage.buckets: contracts, recordings, receipts, knowledge

Styling:
  Tailwind CSS via CDN (not PostCSS build)
  Custom config in index.html <script> tag
  Dark theme: background #0B1121, surface #151e32
  Glass morphism effects throughout
  RTL: use logical properties (ms-/me- not ml-/mr-)

Libraries:
  @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities -> Kanban drag & drop
  react-big-calendar + date-fns -> Calendar with Hebrew locale
  Tailwind CSS via CDN (not PostCSS build)

Key Patterns:
  - Modal z-index: z-[60] (above sidebar z-50)
  - custom-scrollbar CSS class in index.html
  - Hebrew localized dates, currency, text
  - DB row interfaces for type safety
  - safeJsonParse helper for crash-safe JSON
  - Atomic operations with rollback support
  - Confirm modals for destructive actions
  - allUsers from AuthContext for user dropdowns
  - is_admin() SECURITY DEFINER function for RLS
  - Edge Functions with service_role key for admin operations
  - Gemini thinking-parts filter in all AI functions (except 2.0-flash-lite which has none)
  - gemini-2.5-flash REST API does NOT support responseMimeType/thinkingConfig/responseSchema
  - For simple JSON generation, use gemini-2.0-flash-lite (no thinking overhead)
  - NoteType: 'manual' | 'transcript_summary' | 'recommendation_summary' | 'proposal_focus' | 'personality_insight'
  - MESSAGE_PURPOSES in constants.ts for WhatsApp purpose options
  - Multi-tenant: all data scoped by tenant_id, RLS enforces isolation
  - Freelancer: assigned_to filtering in RLS, mini dashboard, scoped sidebar

GIT HISTORY (key commits):
  443c937 - Fix 19 audit issues
  [session 2 commits] - 9 features
  [session 3 commits] - theme, viewer fix, file uploads
  [session 4 commits] - retainer history, advanced roles, RLS, user sync
  6925a1a - Edge Function for admin user creation
  1085824 - Viewers can see all leads
  0c3cea1 - Enhanced client management (handler, notes, CRM view)
  89a3947 - Lead management upgrade (handler, notes, profile page)
  fd2946a - Call transcripts, AI recommendations, Canva proposals
  67f4fa4 - API keys stored server-side only
  6d6edbb - Persistent AI recommendations, expandable notes
  e1e83c7 - WhatsApp outgoing messages + AI audio transcription
  5643ebc - Improve transcription error messages
  c45cf30 - Audio upload MIME type handling
  83231d7 - Remove Hebrew chars from storage file paths
  ef5a45c - Improve transcription prompt (separator + Hebrew)
  de6cefd - Upgrade transcription to gemini-2.5-flash
  f143444 - Gemini Files API to avoid memory limit
  83c5840 - AI Summary Notes (3 types)
  c3080f8 - Inline profile editing, proposal focus, WhatsApp fix
  c14c9b3 - Gemini model upgrade + MEMORY/PROJECT docs update
  9b73c62 - Debug: detailed error logging for WhatsApp generation
  5c4b723 - Fix: switch WhatsApp to gemini-2.0-flash-lite for reliability
  5f6783d - Docs: project story update
  f6b39ba - Signals OS personality intelligence integration
  [pending] - Kanban drag & drop + Calendar + AI Receipt scanning
  [pending] - Multi-Tenant + Freelancer + Voice + Ideas + Knowledge (Session 12)

===============================================================================
SESSION 13 (2026-02-17) - Bug Fixes + Feature Improvements
===============================================================================

WHAT HAPPENED:
Fixed critical POST 400 error on expense insert after multi-tenant migration,
plus 4 feature improvements.

BUGS FIXED:

1. EXPENSE INSERT POST 400 (CRITICAL)
   - Root cause: Multi-tenant RLS policies require tenant_id = current_tenant_id()
     AND is_admin(). The current_tenant_id() function returned NULL when
     user_roles.tenant_id was NULL, causing tenant_id = NULL comparison to fail.
   - Fix 1 (DataContext.tsx): withTenant helper ALWAYS sets tenant_id with
     fallback to DEFAULT_TENANT_ID
   - Fix 2 (SQL): current_tenant_id() now uses COALESCE to return default
     tenant UUID instead of NULL
   - Fix 3 (AuthContext.tsx): First user creation now explicitly includes
     tenant_id: '00000000-0000-0000-0000-000000000001'
   - Added detailed console.error logging to addExpense for debugging
   - Comprehensive SQL fix file: supabase-fix-tenant-null.sql

2. LEADS KANBAN DRAG & DROP BROKEN
   - Root cause: useSortable attributes were only on grip handle div,
     not on the card root div. Ideas kanban had it right (attributes on root),
     Leads kanban did not.
   - Fix: Moved {...attributes} from grip handle to card root div,
     kept {...listeners} on grip handle only

FEATURES ADDED:

3. LEADS TABLE — FULL COLUMN SORTING
   - All 8 columns now sortable: שם, עסק, טלפון, מקור, הצעת מחיר, סטטוס, מטפל, תאריך קשר
   - Previously only 2 columns (quotedMonthlyValue, nextContactDate) were sortable
   - Hebrew-aware collation for text columns (localeCompare with 'he')
   - SortField type expanded to include all fields

4. IDEAS AI GENERATION — SOCIAL MEDIA SCRAPING
   - Modal now includes 3 optional URL inputs: Facebook, Instagram, Website
   - Icons: Facebook (blue), Instagram (purple), Globe (green)
   - Edge Function updated: fetches URL content, strips HTML, feeds to Gemini
   - Prompt updated: analyze digital presence, identify gaps, suggest complementary ideas
   - Scrape timeout: 8 seconds per URL, errors silently ignored
   - Response includes scrapedSources array for transparency

5. SIGNALS OS WEBHOOK — TENANT_ID FIXES
   - All webhook inserts now include tenant_id: '00000000-...-000001'
   - signals_personality upserts include tenant_id_fk for RLS
   - New leads created by webhook include tenant_id
   - lead_notes and activity_log inserts include tenant_id

SQL TO RUN:
  supabase-fix-tenant-null.sql (MUST run in Supabase SQL Editor)

EDGE FUNCTIONS DEPLOYED:
  generate-idea (+ URL scraping)
  signals-webhook (+ tenant_id on all inserts)

FILES MODIFIED:
- contexts/DataContext.tsx (addExpense logging, withTenant already there)
- contexts/AuthContext.tsx (tenant_id on first user creation)
- components/Leads.tsx (full column sorting, kanban D&D fix)
- components/Ideas.tsx (social URL inputs in AI generate modal)
- supabase/functions/generate-idea/index.ts (URL scraping + enhanced prompt)
- supabase/functions/signals-webhook/index.ts (tenant_id on all inserts)
- supabase-fix-tenant-null.sql (comprehensive tenant fix + COALESCE)

===============================================================================
SESSION 14 (2026-02-17) - Slug Routing + Tenant Management Upgrade
===============================================================================

WHAT HAPPENED:
Major routing overhaul from HashRouter to BrowserRouter with slug-based
tenant URLs, plus full tenant management admin page.

CHANGES:

1. SLUG-BASED ROUTING
   - HashRouter → BrowserRouter migration
   - URL format: /a/:tenantSlug/* (e.g., /a/my-agency/dashboard)
   - Slug stored on tenants table + backfill script
   - Auto-redirect to slug-based URL on login
   - Login page per tenant: /a/:slug/login

2. TENANT MANAGEMENT PAGE (TenantManagement.tsx)
   - Super admin only (/tenants route)
   - List all tenants with user counts
   - Add/edit tenants with slug
   - Add/remove users per tenant
   - Copy direct login link per tenant

3. EDGE FUNCTION: manage-tenants
   - Actions: list-tenants, create-tenant, update-tenant,
     add-user, remove-user, update-tenant-user
   - Super admin authentication check
   - Deployed to Supabase

SQL MIGRATIONS:
  - supabase-slug-migration.sql (slug column + backfill)
  - supabase-tenant-features-migration.sql (is_active on tenants)

Commits: 3ced376

===============================================================================
SESSION 15 (2026-02-17) - CRITICAL: Tenant Data Isolation + Settings Fix
===============================================================================

WHAT HAPPENED:
Critical security issue discovered: new tenant ("הסקיפים") could see ALL
data from the primary tenant. This was a multi-layered problem requiring
complete RLS overhaul, settings architecture change, and Edge Function updates.

SECURITY ISSUES FOUND & FIXED:

1. CURRENT_TENANT_ID() LEAKING TO DEFAULT TENANT
   - Problem: COALESCE fallback to DEFAULT_TENANT_ID ('000...001') meant
     any unauthenticated/unregistered user got the primary tenant's data
   - Fix: Changed fallback to impossible UUID ('000...000')
   - File: supabase-fix-tenant-isolation.sql
   - Commit: 9368bd4

2. AUTHCONTEXT AUTO-CREATING USER_ROLES WITH DEFAULT TENANT
   - Problem: loadRole created user_roles with DEFAULT_TENANT_ID for unknown users
   - Fix: No auto-creation; show NoTenantScreen instead
   - Added NoTenantScreen to App.tsx (locked screen with logout)
   - File: contexts/AuthContext.tsx, App.tsx
   - Commit: 9368bd4

3. PERMISSIVE RLS POLICIES — THE REAL KILLER
   - Problem: PostgreSQL permissive policies work as OR. Old USING(true)
     policies + new tenant_id = current_tenant_id() = USING(true) wins!
   - Fix: Complete RLS overhaul — DROP ALL old policies, create strict new
     ones for ALL 19 tables. FORCE ROW LEVEL SECURITY on all tables.
   - File: supabase-fix-rls-complete.sql
   - Commit: ca805be

4. SIGNALS-WEBHOOK HARDCODED DEFAULT TENANT
   - Problem: All webhook data went to default tenant
   - Fix: Dynamic tenant resolution: webhook secret → matched entity → DEFAULT
   - File: supabase/functions/signals-webhook/index.ts (rewritten)
   - Commit: ca805be

5. SETTINGS TABLE SHARED SINGLE ROW (ID=1)
   - Problem: transformSettingsToDB sent id: 1 — all tenants write to same row
   - Problem: saveApiKeys used .eq('id', 1)
   - Fix: Changed PK from id to tenant_id, dropped id column entirely
   - File: contexts/DataContext.tsx, supabase-fix-settings-pk.sql
   - Commits: 35b80d3, 26d135e

6. EDGE FUNCTIONS READING WRONG TENANT'S API KEYS
   - Problem: All 8 Edge Functions queried settings without tenant filter
   - Fix: Each function now gets caller's tenant_id from user_roles first
   - Files: All 8 Edge Functions updated and deployed
   - Commit: 35b80d3

7. SETTINGS 409 CONFLICT (duplicate key violation)
   - Problem: PK was still on id column, upsert with onConflict: 'tenant_id' failed
   - Fix: DROP PK on id, DROP id column, ADD PRIMARY KEY (tenant_id)
   - File: supabase-fix-settings-pk.sql
   - Commit: 26d135e

FEATURE ADDED:
- Toggle שכיר/ה (salaried yes/no) in Settings
  - is_salaried boolean column on settings table
  - Toggle switch in Settings.tsx
  - Salary input only shows when isSalaried = true
  - Types, constants, DataContext all updated

SQL MIGRATIONS RUN:
  - supabase-fix-tenant-isolation.sql (current_tenant_id fix)
  - supabase-fix-rls-complete.sql (complete RLS overhaul)
  - supabase-fix-settings-tenant.sql (settings unique constraint)
  - supabase-fix-settings-pk.sql (PK → tenant_id + is_salaried)

EDGE FUNCTIONS DEPLOYED:
  All 8 edge functions redeployed with tenant-aware settings queries:
  ai-recommendations, generate-ai-summary, generate-whatsapp-messages,
  transcribe-audio, generate-proposal, process-receipt, generate-idea,
  summarize-document

FILES MODIFIED:
- contexts/AuthContext.tsx (no auto-creation, tenant filter on refreshUsers)
- contexts/DataContext.tsx (tenant guard, settings per-tenant, withTenant fix)
- App.tsx (NoTenantScreen component)
- types.ts (isSalaried in AgencySettings)
- constants.ts (isSalaried in DEFAULT_SETTINGS)
- components/Settings.tsx (salaried toggle)
- supabase/functions/signals-webhook/index.ts (dynamic tenant resolution)
- All 8 AI Edge Functions (tenant-aware settings)

Commits: 9368bd4, ca805be, 35b80d3, 26d135e

===============================================================================
ARCHITECTURE NOTES (Updated 2026-02-17)
===============================================================================

Data Flow:
  Supabase (PostgreSQL) <-> DataContext.tsx <-> Components
  DB uses snake_case, TypeScript uses camelCase
  Transform functions handle conversion both ways

Component Structure:
  App.tsx (router + auth)
    -> Layout.tsx (sidebar + main area)
      -> [Page Components] (Dashboard, Clients, Leads, etc.)
        -> ClientProfile.tsx / LeadProfile.tsx (full CRM views)
        -> ui/ (Button, Card, Form, Modal, Badge, Table)

State Management:
  Single React Context (DataContext) holds all app state (~1100 lines)
  All CRUD operations are async with try/catch + error toast
  No external state libraries (Redux, Zustand, etc.)

Auth:
  Supabase Auth (email/password)
  Session check on App mount
  Role system: AuthContext.tsx with admin/viewer/freelancer roles
  Multi-tenant: tenant_id on all tables, current_tenant_id() SQL function
  Page-level permissions (page_permissions JSON in user_roles)
  Freelancer: sees only assigned clients/leads (assigned_to = auth.uid())
  First user auto-becomes admin
  Admin creates accounts via Edge Function (no self-registration)
  Slug-based routing: /a/:tenantSlug/* (BrowserRouter)

Security:
  FORCE ROW LEVEL SECURITY on ALL 19 tables
  current_tenant_id() returns impossible UUID ('000...000') as fallback
  No permissive USING(true) policies — all strict tenant_id checks
  Settings keyed by tenant_id (PK), not shared id=1 row
  Edge Functions filter settings by caller's tenant_id
  signals-webhook: dynamic tenant resolution from webhook secret

AI / Gemini:
  gemini-3-pro-preview -> ai-recommendations, generate-ai-summary (quality)
  gemini-2.5-flash -> transcribe-audio (speed, large token counts)
  gemini-2.0-flash-lite -> generate-whatsapp-messages, generate-idea, summarize-document (no thinking parts, reliable JSON)
  gemini-2.0-flash -> process-receipt (Vision API, receipt OCR, temperature 0.1)
  API key stored server-side only (settings.gemini_api_key)
  Thinking parts filter: if (part.text && !part.thought) — needed for 2.5+ and 3.x
  gemini-2.0-flash-lite has NO thinking parts (simpler, ideal for JSON generation)
  WARNING: responseMimeType/thinkingConfig/responseSchema NOT supported in 2.5-flash REST API
  Audio uses Gemini Files API (resumable upload -> file_uri)

Edge Functions (11 total):
  create-user -> Admin account creation (+ role + tenantId)
  manage-tenants -> Super admin tenant CRUD (list/create/update/add-user/remove-user/update-tenant-user)
  ai-recommendations -> AI advice via Gemini 3 Pro
  generate-ai-summary -> 3 summary types via Gemini 3 Pro
  generate-whatsapp-messages -> 3 message variants via Gemini 2.0 Flash-Lite
  transcribe-audio -> Audio -> text via Gemini Files API (2.5 Flash)
  generate-proposal -> PDF via Canva Connect API
  generate-strategy -> AI strategy & action plan via Gemini 3 Pro
  process-receipt -> Receipt OCR via Gemini 2.0 Flash Vision
  generate-idea -> AI idea generation via Gemini 2.0 Flash-Lite
  summarize-document -> AI document summarization via Gemini 2.0 Flash-Lite
  signals-webhook -> Personality data from Signals OS (dynamic tenant resolution)

Supabase Tables (all have tenant_id uuid FK + FORCE RLS):
  tenants (id, name, slug, is_active)
  clients (+ assigned_to uuid)
  leads (+ created_by, assigned_to uuid)
  deals, expenses (+ is_recurring, receipt_url), payments
  settings (PK = tenant_id, + employee_salary, is_salaried, gemini_api_key, canva_api_key, canva_template_id, signals_webhook_secret)
  activity_log, retainer_changes
  client_notes (+ note_type, source_id)
  lead_notes (+ note_type, source_id)
  call_transcripts (client_id, lead_id, transcript, summary, recording_url)
  ai_recommendations (client_id, lead_id, recommendation)
  whatsapp_messages (client_id, lead_id, message_text, purpose, is_ai_generated)
  calendar_events (id, title, event_type, start_time, end_time, all_day, description, client_id, lead_id)
  ideas (id, title, description, status, priority, client_id, category, tags, assigned_to, due_date, sort_order)
  knowledge_articles (id, title, content, summary, category, tags, file_url, is_ai_generated)
  user_roles (user_id, email, role, display_name, page_permissions, tenant_id)
  strategy_plans (id, client_id, lead_id, entity_name, plan_data JSONB, raw_text, public_url, created_by, created_by_name)
  signals_personality (+ tenant_id_fk uuid FK — separate from text tenant_id)
  storage.buckets: contracts, recordings, receipts, knowledge, logos, strategy-pages

Styling:
  Tailwind CSS via CDN (not PostCSS build)
  Custom config in index.html <script> tag
  Dark theme: background #0B1121, surface #151e32
  Glass morphism effects throughout
  RTL: use logical properties (ms-/me- not ml-/mr-)

Libraries:
  @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities -> Kanban drag & drop
  react-big-calendar + date-fns -> Calendar with Hebrew locale
  Tailwind CSS via CDN (not PostCSS build)

Key Patterns:
  - Modal z-index: z-[60] (above sidebar z-50)
  - custom-scrollbar CSS class in index.html
  - Hebrew localized dates, currency, text
  - DB row interfaces for type safety
  - safeJsonParse helper for crash-safe JSON
  - Atomic operations with rollback support
  - Confirm modals for destructive actions
  - allUsers from AuthContext for user dropdowns
  - is_admin() SECURITY DEFINER function for RLS
  - Edge Functions with service_role key for admin operations
  - Gemini thinking-parts filter in all AI functions (except 2.0-flash-lite which has none)
  - gemini-2.5-flash REST API does NOT support responseMimeType/thinkingConfig/responseSchema
  - For simple JSON generation, use gemini-2.0-flash-lite (no thinking overhead)
  - NoteType: 'manual' | 'transcript_summary' | 'recommendation_summary' | 'proposal_focus' | 'personality_insight'
  - MESSAGE_PURPOSES in constants.ts for WhatsApp purpose options
  - Multi-tenant: all data scoped by tenant_id, RLS enforces isolation
  - Freelancer: assigned_to filtering in RLS, mini dashboard, scoped sidebar
  - Slug routing: /a/:tenantSlug/*, BrowserRouter, auto-redirect on login

GIT HISTORY (key commits):
  443c937 - Fix 19 audit issues
  [session 2 commits] - 9 features
  [session 3 commits] - theme, viewer fix, file uploads
  [session 4 commits] - retainer history, advanced roles, RLS, user sync
  6925a1a - Edge Function for admin user creation
  1085824 - Viewers can see all leads
  0c3cea1 - Enhanced client management (handler, notes, CRM view)
  89a3947 - Lead management upgrade (handler, notes, profile page)
  fd2946a - Call transcripts, AI recommendations, Canva proposals
  67f4fa4 - API keys stored server-side only
  6d6edbb - Persistent AI recommendations, expandable notes
  e1e83c7 - WhatsApp outgoing messages + AI audio transcription
  5643ebc - Improve transcription error messages
  c45cf30 - Audio upload MIME type handling
  83231d7 - Remove Hebrew chars from storage file paths
  ef5a45c - Improve transcription prompt (separator + Hebrew)
  de6cefd - Upgrade transcription to gemini-2.5-flash
  f143444 - Gemini Files API to avoid memory limit
  83c5840 - AI Summary Notes (3 types)
  c3080f8 - Inline profile editing, proposal focus, WhatsApp fix
  c14c9b3 - Gemini model upgrade + MEMORY/PROJECT docs update
  9b73c62 - Debug: detailed error logging for WhatsApp generation
  5c4b723 - Fix: switch WhatsApp to gemini-2.0-flash-lite for reliability
  5f6783d - Docs: project story update
  f6b39ba - Signals OS personality intelligence integration
  [session 11] - Kanban drag & drop + Calendar + AI Receipt scanning
  [session 12] - Multi-Tenant + Freelancer + Voice + Ideas + Knowledge
  [session 13] - Bug fixes + feature improvements
  3ced376 - Slug routing + tenant management upgrade
  9368bd4 - Critical: tenant data isolation fix
  ca805be - Complete RLS overhaul + signals-webhook tenant isolation
  35b80d3 - Settings tenant isolation (Edge Functions + unique constraint)
  26d135e - Settings PK → tenant_id + salaried toggle + upsert fix
  746146d - Signals OS block in LeadProfile (send questionnaire + copy link)
  2dcfb64 - PDF upload → AI recommendations + auto-trigger from webhook

===============================================================================
SESSION 16 (2026-02-17) - Signals OS: Send Questionnaire + PDF → AI Recs
===============================================================================

WHAT HAPPENED:
Three Signals OS enhancements: (1) Send questionnaire button in lead profile,
(2) PDF upload for deeper AI analysis, (3) Auto-trigger recommendations on
webhook personality data arrival.

CHANGES:

1. SIGNALS OS BLOCK IN LEAD PROFILE
   - Always visible Card (not just when personality exists)
   - STATE 1 (no personality):
     - Amber "no questionnaire sent" indicator
     - Green WhatsApp button — pre-composed message + personalized link
     - Copy link button for alternative sharing
     - Message preview (expandable)
     - PDF upload button for existing Signals reports
   - STATE 2 (has personality):
     - All existing personality display (archetypes, scores, cheat sheets)
     - + "Upload PDF for deep analysis" button
     - + "Generate AI recommendations" button

2. QUESTIONNAIRE LINK FORMAT
   - URL: signals-os.alma-ads.co.il/widget?questionnaire=v3-biz-owner
   - Pre-fills: subject_email, subject_name, subject_phone, external_id, source_id
   - WhatsApp message: sales pitch about free diagnostic tool

3. PDF UPLOAD → AI RECOMMENDATIONS
   - User uploads Signals OS report PDF
   - Sent as FormData to ai-recommendations Edge Function
   - Gemini 3 Pro reads PDF via inline_data (base64)
   - Generates 9-point deep recommendations (vs standard 5):
     - Standard 1-5 + personality analysis + communication style +
       what NOT to do + optimal proposal framing

4. AI-RECOMMENDATIONS EDGE FUNCTION UPGRADE
   - Now supports both JSON (existing) and FormData (with PDF)
   - Detects content-type to choose parsing method
   - PDF converted to base64, sent as inline_data to Gemini
   - Auto-fetches personality from DB when leadId provided
   - maxOutputTokens raised to 4096

5. AUTO-TRIGGER RECOMMENDATIONS ON WEBHOOK
   - useEffect watches personality.receivedAt
   - When personality data arrives (from webhook), auto-calls handleGetRecommendations
   - Only triggers if no existing recommendations (prevents duplicates)
   - Sets autoRecTriggered flag to prevent re-firing

EDGE FUNCTIONS DEPLOYED:
  ai-recommendations (FormData + PDF support)

FILES MODIFIED:
- components/LeadProfile.tsx (Signals OS block, PDF upload, auto-trigger useEffect)
- supabase/functions/ai-recommendations/index.ts (FormData + PDF inline_data)

Commits: 746146d, 2dcfb64

===============================================================================
SESSION 17 (2026-02-17) - Bulk Import: 177 Old Clients → Leads
===============================================================================

WHAT HAPPENED:
User had an old Excel file (לקוחות פוטנציאליים.xlsx) with 177 past clients.
Imported all of them as leads into Supabase with status "לא רלוונטי".

PROCESS:
1. Read .xlsx with Node.js xlsx library (copied to ASCII path first — Hebrew paths fail)
2. Parsed 177 rows: שם טוב (name), עסק (business), טלפון (phone), קטגוריה, לידים/מוצר
3. Generated leads with:
   - status: "לא רלוונטי"
   - created_at / next_contact_date: 2026-01-01
   - source_channel: "אחר"
   - notes: original category (לידים/מוצר)
   - Phone normalized (0-prefix, +972 → 0, dashes removed, #ERROR! → empty)
4. Inserted via Supabase REST API (service_role key) in 4 batches of 50
5. Verified in SQL Editor: 187 total "לא רלוונטי" leads (177 new + 10 existing)

TOOLS USED:
- Node.js xlsx library to read Excel
- Supabase REST API POST /rest/v1/leads with service_role Bearer token
- supabase CLI: `npx supabase projects api-keys` to get service_role key

FILES CREATED (temp, not committed):
- import_leads.js (Node.js import script)
- generate_sql.js (SQL generator — used REST API instead)
- supabase-import-old-clients.sql (177 INSERT VALUES — backup)
- read_excel.js (Excel reader utility)

===============================================================================
SESSION 18 (2026-02-17) - Personality-Aware WhatsApp + PDF Extraction + Keys Copy
===============================================================================

WHAT HAPPENED:
Four improvements: (1) WhatsApp messages adapted to Signals personality,
(2) Editable questionnaire message, (3) PDF upload extracts & saves personality
to DB, (4) Copy API keys between tenants.

CHANGES:

1. PERSONALITY-AWARE WHATSAPP MESSAGES
   - generate-whatsapp-messages Edge Function: accepts personality param
   - Builds personality context (archetype, churn risk, smart tags) + style guide
     (how_to_speak, what_not_to_do, closing_speed, best_offers, red_flags)
   - When personality exists: 3 variants adapted to archetype (not generic)
   - LeadProfile.tsx: passes personality object, purple badge indicator,
     button text changes to "🧠 צור הודעות מותאמות"

2. EDITABLE QUESTIONNAIRE MESSAGE
   - Hardcoded waMessage → editable textarea with states
   - signalsMessageEditing + signalsMessageText states
   - Edit/reset buttons: "ערוך הודעה" / "חזור לטקסט ברירת מחדל"
   - Clickable preview to enter edit mode

3. PDF UPLOAD → EXTRACT PERSONALITY → SAVE TO DB
   - Problem: signals_personality table was EMPTY — PDF uploads never saved
     structured personality data, only generated text recommendations
   - Fix: ai-recommendations Edge Function step 7:
     - Gemini 2.0-flash-lite extracts structured personality JSON from PDF
     - Upsert to signals_personality (archetype, scores, cheat sheets)
     - questionnaire_version: 'pdf-import'
   - pdfLeadId lifted to outer scope for use in step 7
   - LeadProfile: 1.5s delay after PDF upload for realtime sync

4. COPY API KEYS BETWEEN TENANTS
   - Copied gemini_api_key + signals_webhook_secret from Default Agency to הסקיפים
   - Via Supabase REST API PATCH with service_role key
   - Tenant IDs: Default = 00000000-...-000001, הסקיפים = 6852f3bd-01d4-4514-a2bb-ccaeee156a22

5. USER QUESTION ANSWERED: Multi-Tenant Code Deployment
   - Frontend (Vercel): auto-deploys to ALL tenants on git push
   - Edge Functions: shared after deploy, one function for all tenants
   - Data: separated per tenant (RLS + tenant_id)
   - Settings (API keys): per-tenant, must be configured individually

EDGE FUNCTIONS DEPLOYED:
  generate-whatsapp-messages (personality-aware)
  ai-recommendations (PDF personality extraction + DB save)

FILES MODIFIED:
- components/LeadProfile.tsx (personality pass-through, editable message, PDF delay)
- supabase/functions/generate-whatsapp-messages/index.ts (personality context + style guide)
- supabase/functions/ai-recommendations/index.ts (step 7: extract + save personality)

Commits: a3c36e9, ebf1e29, bada4ad
Pushed to GitHub -> Vercel auto-deployed.

===============================================================================
SESSION 19 (2026-02-18) - PDF Full Extraction Fix + Knowledge Base Download +
                          Summarize Fix + AI Agent Army Planning
===============================================================================

WHAT HAPPENED:
Fixed PDF personality extraction (was truncated), added file download to
Knowledge Base, fixed document summarization (was hallucinating), planned
full AI agent army roadmap (14 agents in 4 waves).

CHANGES:

1. PDF FULL PERSONALITY EXTRACTION FIX
   - Problem: Gemini was asked for "short description" per field, so full
     Signals OS reports (business intelligence, call scripts, FOMO) got
     truncated to one-line summaries
   - Fix: Prompt now requests FULL text, not summaries
   - New fields: closing_line, calibration_questions, fomo_message, call_script
   - user_report + business_report saved to DB (were null before)
   - maxOutputTokens raised from 2048 to 8192
   - Condition changed: always extract (removed !personality check)
   - UI: new expandable blocks "Business Intelligence Report" + "User Report"
   - UI: cheat sheet values now support long text (whitespace-pre-wrap)

2. KNOWLEDGE BASE DOWNLOAD BUTTON
   - Added Download icon on article cards (visible on hover)
   - Added "Download" button in edit modal next to filename
   - Allows sharing documents directly from the system

3. DOCUMENT SUMMARIZATION FIX
   - Problem: Frontend sent only filename string to summarize-document,
     not the actual file content. Gemini hallucinated summaries from filename.
   - Fix: Edge Function now accepts FormData with actual file
   - Sends file as inline_data to Gemini 2.0-flash (not lite, for PDF support)
   - Frontend sends file via FormData instead of JSON

4. AI AGENT ARMY PLANNING
   - Created NIV_IDEAS.txt with full roadmap
   - 14 agents across 4 waves:
     Wave 1 (Week 1-2): Cron Alerts, Follow-up Agent, Meeting Prep
     Wave 2 (Week 3-4): Competitor Scout, Churn Detective, Creative Agent,
                         Upsell Matchmaker
     Wave 3 (Week 5-8): AI Notebook, Monthly Strategist, Playbook Builder,
                         Smart Scheduler
     Wave 4 (Month 3+): Super Agent (AI Agent Builder)
   - 3 new agent ideas from Niv:
     #19 Competitor Scout: scans competitors, generates FOMO per archetype
     #20 AI Notebook: per-client context brain (like Google NotebookLM)
     #21 Super Agent: describe business -> system builds custom AI agent
   - Full architecture diagram + DB tables needed + build order

EDGE FUNCTIONS DEPLOYED:
  ai-recommendations (full PDF extraction)
  summarize-document (reads actual file, not just filename)

FILES MODIFIED:
- supabase/functions/ai-recommendations/index.ts (full extraction, 8192 tokens)
- supabase/functions/summarize-document/index.ts (FormData + inline_data)
- components/LeadProfile.tsx (business/user report blocks, long text support)
- components/KnowledgeBase.tsx (download buttons, FormData upload for summary)

FILES CREATED:
- NIV_IDEAS.txt (AI agent army roadmap — 14 agents, 4 waves, full architecture)

Commits: faf132f, a5f9290, bc427d8
Pushed to GitHub -> Vercel auto-deployed.

===============================================================================
SESSION 20 (2026-02-19) - PDF Fixes + AI Notebook + Strategy & Action Plan
===============================================================================

WHAT HAPPENED:
Multiple features implemented in one session: fixed PDF visibility, added
AI Notebook to LeadProfile, built complete Strategy & Action Plan feature
(replaces user's manual ChatGPT->Canva workflow), added animated HTML export
for strategies.

CHANGES:

1. PDF DROPDOWN VISIBILITY FIX
   - Problem: PDF dropdown in ClientProfile used CSS `group-hover:block` —
     invisible on touch/click
   - Fix: Converted to click-toggle with `pdfDropdownOpen` state +
     click-outside handler
   - Changed label from "PDF" to "ייצוא PDF" with colored icons per option
   - Added full PDF dropdown to LeadProfile (was just conditional personality PDF)
   - New "Lead Brief" option uses generateCustomPdf

2. AI NOTEBOOK IN LEAD PROFILE
   - Was missing from LeadProfile (only existed in ClientProfile)
   - Added: state, handleNotebookSend handler, full chat UI with quick prompts
   - Added 'notebook' to LEAD_SECTIONS for section reorder

3. STRATEGY & ACTION PLAN — NEW FEATURE (Full E2E)
   Replaces Niv's manual workflow: meeting -> dictation -> ChatGPT -> Canva -> PDF

   a) DATABASE: New `strategy_plans` table
      - id, client_id, lead_id, entity_name, plan_data (JSONB), raw_text
      - RLS: SELECT/INSERT all authenticated, DELETE admin only

   b) TYPES: 7 new interfaces
      - StrategyAction, StrategyPhase, StrategySituationAnalysis, StrategyKPI
      - StrategyPlanData, StrategyPlan (added to AppData)

   c) EDGE FUNCTION: generate-strategy (~465 lines)
      - Auth + tenant lookup + Gemini API key from settings
      - Server-side CRM context gathering (like ai-notebook pattern):
        client/lead profile, notes (30), transcripts (10), recommendations (5),
        WhatsApp (20), personality, competitor reports, financials
      - Hebrew prompt: senior marketing consultant analysis
      - Structured JSON output: summary, situationAnalysis (5 categories),
        actionPlan (3 phases: 30/60/90 days), KPIs
      - gemini-3-pro-preview, temp 0.5, 8192 tokens
      - 3-level JSON parsing fallback + raw_text storage

   d) DATA CONTEXT: addStrategyPlan + deleteStrategyPlan CRUD
      - StrategyPlanRow interface, transform functions with safeJsonParse
      - Added to Promise.all data loading

   e) PDF GENERATOR: generateStrategyPdf()
      - Custom buildColoredList + buildPhaseSection helpers
      - Branded header, summary KPIs, situation analysis, phase tables, KPI grid

   f) UI: Strategy block in ClientProfile + LeadProfile
      - 'strategy' section with expandable strategy cards
      - Generate button, loading state, error handling
      - Color-coded situation analysis grid (green/red/blue/amber)
      - Phase blocks with numbered actions, owner badges, KPI metrics
      - PDF + Animated export buttons, admin-only delete

4. ANIMATED STRATEGY EXPORT
   - File: utils/animatedStrategy.ts (~450 lines)
   - Standalone animated HTML page generator
   - CSS animations: scroll-triggered reveals via IntersectionObserver
   - SVG arrow connectors between phases with dash flow animation
   - Floating gradient glow backgrounds with brand colors
   - Print-friendly CSS fallback, Heebo font, RTL Hebrew
   - Opens in new window via window.open() + document.write()

EDGE FUNCTIONS DEPLOYED:
  generate-strategy (new)

SQL MIGRATION:
  supabase/migrations/20260219150000_add_strategy_plans.sql

NEW FILES:
- supabase/migrations/20260219150000_add_strategy_plans.sql
- supabase/functions/generate-strategy/index.ts
- utils/animatedStrategy.ts

FILES MODIFIED:
- types.ts (strategy interfaces + AppData)
- contexts/DataContext.tsx (strategy CRUD + loading)
- utils/pdfGenerator.ts (generateStrategyPdf)
- components/ClientProfile.tsx (PDF fix + strategy section)
- components/LeadProfile.tsx (PDF fix + AI notebook + strategy section)

Commits: 06e8aad, 037a40c, 5d35281
Pushed to GitHub -> Vercel auto-deployed.

===============================================================================
SESSION 21 (2026-02-19) - Strategy Edit/Publish + KPI Colors + Logo Removal
===============================================================================

WHAT HAPPENED:
Four user-requested fixes: (1) dark KPI cards on Clients page, (2) explicit
logo removal option, (3) shareable public links for animated strategy pages,
(4) editable strategy content before sharing.

CHANGES:

1. CLIENTS PAGE KPI CARDS — COLOR FIX
   - Problem: Cards used `bg-[#151C2C]` — too dark, nearly invisible
   - Fix: Changed to `bg-surface/80 backdrop-blur-md border-white/10`
     (glass style)
   - Added hover border effects (emerald for income, primary for profit)
   - Labels upgraded from text-gray-500 to text-gray-400

2. LOGO REMOVAL — EXPLICIT BUTTON
   - Problem: Delete was a tiny red X on hover, easy to miss
   - Fix: Added proper "הסר לוגו" Button with variant="danger" and Trash2 icon
   - Only shows when logo exists
   - Removed the hover-only X button

3. SHAREABLE STRATEGY LINKS
   - New `strategy-pages` Supabase storage bucket (public, HTML, 5MB)
   - `public_url` column added to strategy_plans table
   - `publishStrategyPage()` function in DataContext:
     - Builds HTML via buildAnimatedStrategyHtml()
     - Uploads to Supabase Storage as {tenantId}/{planId}.html
     - Gets public URL, saves to DB, copies to clipboard
   - "פרסם לינק" button in strategy actions (both profiles)
   - Public URL display bar with copy button when published
   - "עדכן לינק" re-publishes with latest content
   - Delete strategy also cleans up storage file

4. STRATEGY EDIT MODAL
   - `updateStrategyPlan()` function in DataContext (DB update + state)
   - Full edit modal (size="xl") in both ClientProfile + LeadProfile:
     - Executive summary textarea
     - Situation analysis: 5 textarea fields (line-separated items)
     - Action plan phases: edit/delete phases, edit/delete/add actions
     - KPIs: edit/delete rows
   - Auto re-publishes animated page if public URL exists on save
   - `buildAnimatedStrategyHtml()` extracted as separate export from
     animatedStrategy.ts

5. ANIMATED STRATEGY REFACTOR
   - Refactored: main function split into `buildAnimatedStrategyHtml()`
     (returns string) and `generateAnimatedStrategy()` (opens window, calls build)
   - Both exported for different use cases

SQL MIGRATION:
  20260219160000_strategy_public_url.sql
  - ALTER TABLE strategy_plans ADD COLUMN public_url TEXT
  - CREATE storage bucket strategy-pages (public, HTML)
  - Storage policies (public read, auth insert/delete)
  - UPDATE policy for strategy_plans

FILES MODIFIED:
- types.ts (publicUrl on StrategyPlan)
- contexts/DataContext.tsx (publishStrategyPage, updateStrategyPlan, storage cleanup)
- components/ClientProfile.tsx (KPI color fix, logo removal, strategy edit modal,
  publish/update link, public URL display)
- components/LeadProfile.tsx (strategy edit modal, publish/update link, public URL display)
- components/Settings.tsx (logo removal button)
- utils/animatedStrategy.ts (split into buildAnimatedStrategyHtml + generateAnimatedStrategy)

Commits: 019ee44
Pushed to GitHub -> Vercel auto-deployed.

===============================================================================
SESSION 22 (2026-02-19) - Vercel API Route Proxy + Animated Proposal Fixes
===============================================================================

WHAT HAPPENED:
Critical fix for published proposal links showing gibberish/text. Supabase
Storage enforces text/plain Content-Type for HTML files (sandbox CSP security).
Solution: store HTML in DB, serve via Vercel serverless functions with correct
Content-Type headers.

CHANGES:

1. VERCEL API ROUTE PROXY (Critical Fix)
   - Problem: Supabase Storage serves HTML as text/plain with sandbox CSP
   - Root cause: Security feature, cannot be overridden
   - Solution: Store HTML in DB column, serve via Vercel serverless functions

   a) SQL Migration: Added html_content TEXT column to proposals + strategy_plans
   b) api/p/[id].ts — Vercel serverless function for proposals
      - Reads html_content from proposals table via Supabase client
      - Returns with Content-Type: text/html; charset=UTF-8
      - Cache-Control: public, max-age=3600, s-maxage=86400
      - Hebrew 404 page on not found
   c) api/s/[id].ts — Same for strategy_plans
   d) vercel.json — API route rewrites before SPA catch-all:
      /api/p/:id → /api/p/[id]
      /api/s/:id → /api/s/[id]
   e) DataContext.tsx — Updated publishProposalPage + publishStrategyPage:
      - Now stores HTML in html_content column
      - Public URL = /api/p/{id} or /api/s/{id} (Vercel URL)
      - Removed Supabase Storage upload/cleanup
   f) Vercel env var: SUPABASE_SERVICE_ROLE_KEY added

2. ANIMATED PROPOSAL — SOCIAL PROOF FIXES (from previous session)
   - Fixed logo visibility in dark sections (white/light filter)
   - Fixed testimonial count to match actual array length
   - Reordered carousel dots/indicators

SQL MIGRATION:
  20260219170538_add_html_content_columns.sql

NEW FILES:
- api/p/[id].ts (Vercel serverless function)
- api/s/[id].ts (Vercel serverless function)
- supabase/migrations/20260219170538_add_html_content_columns.sql

FILES MODIFIED:
- vercel.json (API rewrites)
- contexts/DataContext.tsx (publish functions rewritten)

Commits: 00e9bd9
Pushed to GitHub -> Vercel auto-deployed.

===============================================================================
SESSION 23 (2026-02-19) - Duplicate Proposals + Testimonials + Telegram Fix
===============================================================================

WHAT HAPPENED:
Three feature additions + Telegram bot overhaul:
1. Proposal duplication button
2. Testimonial improvements (reorder, swipe, read more)
3. 15 breakthrough CRM ideas documented
4. Telegram bot fixes (name search, audio transcription, error handling)

CHANGES:

1. PROPOSAL DUPLICATION ("שכפל")
   - New "שכפל" button in LeadProfile.tsx next to "ערוך"
   - Uses existing addProposal() with copied proposalData
   - Copies: proposalData, leadId
   - Resets: id (new), status='draft', no publicUrl/signature
   - Name: appends " (העתק)" to proposal name

2. TESTIMONIAL REORDER
   - Reordered PROPOSAL_TESTIMONIALS array in proposalSocialProof.ts
   - New order: B-Cure → Great Shape → UFC → SMOOVEE → rest

3. TESTIMONIAL SWIPE (Mobile Touch)
   - Touch events on .testi-viewport: touchstart/touchmove/touchend
   - Horizontal swipe detection (>50px threshold)
   - Distinguishes horizontal swipe from vertical scroll
   - Resets auto-rotation timer after each swipe

4. TESTIMONIAL "READ MORE"
   - CSS: -webkit-line-clamp: 3 on .testi-content (truncation)
   - .testi-content.expanded removes clamp
   - JS: checkTruncation() after 500ms — shows "קרא עוד" button only when content overflows
   - Toggle: expanded class + "קרא עוד" / "הצג פחות" text swap

5. TELEGRAM BOT OVERHAUL
   a) Smart Entity Search (findEntity helper):
      - Searches BOTH lead_name/client_name AND business_name
      - Bidirectional matching: "search includes name" AND "name includes search"
      - Used across ALL action functions (add_note, reschedule, update_field,
        update_lead_status, update_client_status, add_deal, reminder, signals)
      - Fixes: "מאור רילקס קלאב" now finds lead "מאור" with business "רילקס קלאב"
   b) Audio-as-Document Detection:
      - Documents with audio MIME types (audio/*) or audio extensions (.m4a, .mp3, etc.)
        now routed to transcription instead of knowledge base
      - Passes correct MIME type to Gemini (not hardcoded audio/ogg)
   c) Better Error Handling:
      - Main catch block now sends error message to user via Telegram
      - Audio document errors include file size in error message
   d) Deployed: telegram-webhook Edge Function

6. 15 BREAKTHROUGH IDEAS
   - Written to NIV_IDEAS.txt Part 9
   - Ideas: Deal Momentum Score, Revenue Intelligence, Ghost Lead Detection,
     Client Health Heatmap, A/B Proposal Testing, Conversation Intelligence,
     Psychological Pricing, Client Cloning, Auto Case Studies, Churn Prediction,
     Meeting Prep Briefing, Revenue Attribution, Engagement Scoring,
     Win/Loss Analysis, Micro-Commitment Funnel

FILES MODIFIED:
- components/LeadProfile.tsx (duplicate button + ProposalStatus import)
- utils/proposalSocialProof.ts (testimonial reorder)
- utils/animatedProposal.ts (swipe + read more CSS/HTML/JS)
- supabase/functions/telegram-webhook/index.ts (smart search + audio routing + errors)
- NIV_IDEAS.txt (Part 9 — 15 ideas)
- PROJECT_STORY.txt (sessions 22-23)
- NIV_PROMPT.md (sessions 22-23)
- MEMORY.md (updated sections)

Pushed to GitHub -> Vercel auto-deployed.
Telegram webhook Edge Function redeployed.
